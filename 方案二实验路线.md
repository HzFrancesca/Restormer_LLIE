# 方案二 (MultiScaleDINOGuidedRestormer) 实验测试路线

## 方案概述

方案二采用多尺度特征金字塔 (FPN) 融合策略，从 DINOv3 不同层提取特征，分别融合到 Restormer Encoder 各层：

- Layer 4 (浅层) → Level 2: 纹理/去噪信息
- Layer 8 (中层) → Level 3: 结构信息  
- Layer 12 (深层) → Latent: 语义/色彩信息

核心优势：同时利用浅层细节和深层语义，适合需要兼顾去噪和色彩恢复的场景。

---

## 阶段一：基线实验

```
实验 1.1: SFT 融合基线
├── 配置: LowLight_DINORestormer_192_2_80k_fpn.yml
├── 设置: fusion_type=sft, gamma=0.35, inject_levels=all
├── 目标: 建立多尺度融合基线 PSNR/SSIM
└── 预计显存: ~10-12 GB

实验 1.2: Gamma 敏感性测试
├── 配置: 修改 dino_gamma
├── 测试值: [0.30, 0.35, 0.40, 0.45]
├── 目标: 找到多尺度融合的最优 gamma
└── 方法: 跑 20k iter 快速对比
```

## 阶段二：融合方式对比

```
实验 2.1: Cross-Attention 融合
├── 配置: LowLight_DINORestormer_192_2_80k_crossattn.yml
├── 设置: fusion_type=cross_attention, fusion_num_heads=8
├── 目标: 对比 SFT vs Cross-Attention 效果
└── 预计显存: ~14-16 GB (显存消耗更大)

实验 2.2: 融合头数消融 (可选)
├── 测试值: fusion_num_heads = [4, 8, 16]
├── 目标: 找到 Cross-Attention 最优头数
└── 注意: 头数越多，计算量越大
```

## 阶段三：注入层级消融

```
实验 3.1: 仅 Latent 层注入
├── 配置: 修改 inject_levels: latent_only
├── 目标: 验证多尺度是否优于单层注入
└── 对比: 与方案一 (Latent 引导) 效果差异

实验 3.2: 仅 Encoder 层注入
├── 配置: 修改 inject_levels: encoder_only
├── 目标: 验证浅层/中层特征的独立贡献
└── 观察: 去噪效果 vs 色彩恢复效果

实验 3.3: 提取层组合消融
├── 测试值: dino_extract_layers = [[12], [8,12], [4,8,12], [4,12]]
├── 目标: 找到最优的 DINO 层组合
└── 注意: 单层时需要调整 FPN 结构
```

## 阶段四：损失函数调优

```
实验 4.1: 语义损失权重
├── 测试值: lambda_sem = [0.01, 0.02, 0.05, 0.1]
├── 目标: 找到语义一致性损失的最优权重
└── 观察: 过高可能导致过度平滑

实验 4.2: 感知损失权重
├── 测试值: lambda_per = [0.02, 0.05, 0.1]
├── 目标: 平衡像素精度与感知质量
└── 指标: 关注 LPIPS 变化
```

---

## 推荐执行顺序

| 优先级 | 实验 | 配置文件 | 预计时间 |
|-------|------|---------|---------|
| 1 | 1.1 SFT 基线 | `LowLight_DINORestormer_192_2_80k_fpn.yml` | 8-10h |
| 2 | 1.2 Gamma 测试 | 修改 gamma, 跑 20k iter | 2h × 4 |
| 3 | 2.1 Cross-Attention | `LowLight_DINORestormer_192_2_80k_crossattn.yml` | 10-12h |
| 4 | 3.1 Latent Only | 修改 inject_levels | 8h |
| 5 | 3.3 提取层消融 | 修改 extract_layers | 8h × 3 |
| 6 | 4.1 语义损失调优 | 修改 lambda_sem | 8h × 3 |

---

## 实验记录模板

| 实验 | Gamma | 融合方式 | 注入层级 | PSNR | SSIM | LPIPS | 显存 | 备注 |
|-----|-------|---------|---------|------|------|-------|------|------|
| 1.1 | 0.35 | SFT | all | | | | ~11GB | 基线 |
| 1.2a | 0.30 | SFT | all | | | | | |
| 1.2b | 0.40 | SFT | all | | | | | |
| 1.2c | 0.45 | SFT | all | | | | | |
| 2.1 | 最优 | CrossAttn | all | | | | ~15GB | |
| 3.1 | 最优 | 最优 | latent | | | | | |
| 3.2 | 最优 | 最优 | encoder | | | | | |

---

## 运行命令

```bash
# 实验 1.1: SFT 融合基线
python basicsr/train.py -opt LLIE/Options/LowLight_DINORestormer_192_2_80k_fpn.yml

# 实验 2.1: Cross-Attention 融合
python basicsr/train.py -opt LLIE/Options/LowLight_DINORestormer_192_2_80k_crossattn.yml
```

---

## 关键配置参数说明

```yaml
network_g:
  # 多尺度 FPN 核心配置
  fusion_type: sft                    # 'sft' 或 'cross_attention'
  fusion_num_heads: 4                 # Cross-Attention 头数
  dino_extract_layers: [4, 8, 12]     # DINO 提取层
  inject_levels: all                  # 'all', 'latent_only', 'encoder_only'
```

---

## 配置文件列表

- `LLIE/Options/LowLight_DINORestormer_192_2_80k_fpn.yml` - SFT 融合基线
- `LLIE/Options/LowLight_DINORestormer_192_2_80k_crossattn.yml` - Cross-Attention 融合
